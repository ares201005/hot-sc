#!/bin/sh


##########
# example for serial jobs
# to run the job, just execute:
#     qsub serial.qsub
##########

#$ -pe orte 1


# change the workding directory to where you submitted the job
#$ -cwd
#$ -o err.out

# merge the standard error stream into the standard output stream instead of having two separate error and output streams
#$ -j y

# request bash shell as shell for job
#$ -S /bin/bash


export OMP_SCHEDULE=DYNAMIC
export OMP_NUM_THREADS=$NSLOTS

#
# print date and time
date
hostname
#cp $SGE_O_WORKDIR/* $TMPDIR
#cd $TMPDIR 



cat >in.freq <<FIN
\$general lphoton=.false., tplasmon=.true., lscba=.false. \$end
\$system nLead=2, norbs=2, onsite=0.6d0, hop=1.0d0, elcoup=1.0d0 miu0=0.d0, half_w(1)=1.d3, half_w(2)=1.d3 \$end
\$temperature telec=300.0d0 \$end
\$land ngrid=10, downrange=0.5d0, uprange=0.5d0 \$end
\$plasmon t_read_file=.false., barrier_e=0.6d0, barrier_h=0.6d0,eps_coup=2.d-3,mscoup=1.0d0,nst=200,eig(1)=-4.0,eig(2)=4.d0,relax=0.01d0 \$end
\$voltage ampG=0.d0, ampl=-0.0d0, ampr=0.0d0 \$end
FIN

file=curr-freq.dat
file2=flux.dat
rm $file $file2

a=0.01
for i in {lower..upper}
do 
 c=$(echo "$i*$a"|bc -l)
 echo "\$photon mode=1,phfreq=$c, \$end" > in.2
 cat in.freq in.2 > new.td

 ../../../../bin/negf-pt <new.td >out 

 curr1=$(grep ' current  through lead:  1 is' out |cut -c32-47)
 curr2=$(grep ' current2 through lead:  1 is' out |cut -c32-47)
 curr3=$(grep ' current  through lead:  2 is' out |cut -c32-47)
 curr4=$(grep ' current2 through lead:  2 is' out |cut -c32-47)
 curr5=$(grep ' current  through lead:  3 is' out |cut -c32-47)
 curr6=$(grep ' current2 through lead:  3 is' out |cut -c32-47)

 echo "$c $curr1  $curr2  $curr3  $curr4  $curr5  $curr6 " >> $file

 flux=$(grep ' absorped photon flux is' out |cut -c27-42)
 maxcurr=$(grep ' maximum photocurrent is' out |cut -c27-42)
 IQE=$(grep ' IQE is  ' out |cut -c29-36)
 eps=$(grep -A 1 'eps+2' out |tail -n 1 |cut -c62-)  # (eps-1)/(eps+2) - 1

 echo "$c $flux  $maxcurr  $IQE $eps " >> $file2

done

rm in.2



# print date and time again
date
